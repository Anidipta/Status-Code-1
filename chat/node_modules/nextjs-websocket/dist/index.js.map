{"version":3,"file":"index.js","sources":["../src/socketNext.js","../src/index.js"],"sourcesContent":["import React, { useRef, useEffect, useState } from 'react'\n\nvar W3CWebSocket = require('websocket').w3cwebsocket\n\nconst WebSocketNext = (props) => {\n  const didMountRef = useRef(false)\n  const [ws, setWS] = useState(new W3CWebSocket(props.url))\n  const [attempts, setAttempts] = useState(1)\n  const [reconnect, setReconnect] = useState(props.reconnect)\n  const [timeoutID, setTimeoutID] = useState(-1)\n\n  useEffect(() => {\n    if (!didMountRef.current) {\n      didMountRef.current = true\n      setupWebsocket()\n    } else {\n      return () => {\n        setReconnect(false)\n        clearTimeout(timeoutID)\n        ws.close()\n      }\n    }\n  }, [])\n\n  const setupWebsocket = () => {\n    ws.onopen = () => {\n      if (typeof props.onOpen === 'function') props.onOpen()\n    }\n    ws.onerror = (e) => {\n      if (typeof props.onError === 'function') props.onError(e)\n    }\n    ws.onmessage = (evt) => {\n      props.onMessage(evt.data)\n    }\n    ws.onclose = (evt) => {\n      if (typeof props.onClose === 'function') {\n        props.onClose(evt.code, evt.reason)\n      }\n      if (reconnect) {\n        const tid = setTimeout(() => {\n          setAttempts(attempts + 1)\n          setWS(new W3CWebSocket(props.url))\n          setupWebsocket()\n        }, props.reconnectIntervalInMilliSeconds || 3000)\n        setTimeoutID(tid)\n      }\n    }\n  }\n\n  return <div />\n}\n\nexport { WebSocketNext }\n","import React from 'react'\n\nimport { WebSocketNext } from './socketNext'\n\nvar W3CWebSocket = require('websocket').w3cwebsocket\n\nclass WebSocket extends React.Component {\n  constructor(props) {\n    super(props)\n    this.state = {\n      ws: new W3CWebSocket(this.props.url),\n      attempts: 1\n    }\n    this.sendMessage = this.sendMessage.bind(this)\n    this.setupWebsocket = this.setupWebsocket.bind(this)\n  }\n\n  logging(logline) {\n    if (this.props.debug === true) {\n      console.log(logline)\n    }\n  }\n\n  generateInterval(k) {\n    if (this.props.reconnectIntervalInMilliSeconds > 0) {\n      return this.props.reconnectIntervalInMilliSeconds\n    }\n    return Math.min(30, Math.pow(2, k) - 1) * 1000\n  }\n\n  setupWebsocket() {\n    let websocket = this.state.ws\n\n    websocket.onopen = () => {\n      this.logging('Websocket connected...')\n      if (typeof this.props.onOpen === 'function') this.props.onOpen()\n    }\n\n    websocket.onerror = (e) => {\n      if (typeof this.props.onError === 'function') this.props.onError(e)\n    }\n\n    websocket.onmessage = (evt) => {\n      this.props.onMessage(evt.data)\n    }\n\n    this.shouldReconnect = this.props.reconnect\n    websocket.onclose = (evt) => {\n      this.logging(\n        `Websocket disconnected,the reason: ${evt.reason},the code: ${evt.code}`\n      )\n      if (typeof this.props.onClose === 'function')\n        this.props.onClose(evt.code, evt.reason)\n      if (this.shouldReconnect) {\n        let time = this.generateInterval(this.state.attempts)\n        this.timeoutID = setTimeout(() => {\n          this.setState({ attempts: this.state.attempts + 1 })\n          this.setState({ ws: new W3CWebSocket(this.props.url) })\n          this.setupWebsocket()\n        }, time)\n      }\n    }\n  }\n\n  componentDidMount() {\n    const { childRef } = this.props\n    childRef && childRef(this)\n\n    this.setupWebsocket()\n  }\n\n  componentWillUnmount() {\n    const { childRef } = this.props\n    childRef && childRef(undefined)\n\n    this.shouldReconnect = false\n    clearTimeout(this.timeoutID)\n\n    let websocket = this.state.ws\n    websocket.close()\n  }\n\n  sendMessage(message) {\n    let websocket = this.state.ws\n    websocket.send(message)\n  }\n\n  render() {\n    return <div></div>\n  }\n}\n\nexport { WebSocket, WebSocketNext }\n"],"names":["W3CWebSocket","require","w3cwebsocket","WebSocketNext","props","didMountRef","useRef","useState","url","ws","setWS","attempts","setAttempts","reconnect","setReconnect","timeoutID","setTimeoutID","useEffect","current","setupWebsocket","clearTimeout","close","onopen","onOpen","onerror","e","onError","onmessage","evt","onMessage","data","onclose","onClose","code","reason","tid","setTimeout","reconnectIntervalInMilliSeconds","React","WebSocket","state","sendMessage","bind","logging","logline","debug","console","log","generateInterval","k","Math","min","pow","websocket","shouldReconnect","time","setState","componentDidMount","childRef","componentWillUnmount","undefined","message","send","render","Component"],"mappings":"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"}